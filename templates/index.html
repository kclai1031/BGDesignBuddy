<!DOCTYPE html>
<html lang="en">
<head>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='css/style.css') }}">
    
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Board Game Idea Generator</title>
    <style>
        .container {
            max-width: 800px;
            margin: 0 auto;
        }
        label, select, input, button {
            display: block;
            margin: 10px 0;
        }
        .flex-row {
            display: flex;
            align-items: center;
        }
        .random-button {
            margin-left: 10px;
        }
    </style>
    <script>
        let allThemes = {{ themes | safe }};  // From Flask, an array of available themes
        let allMechanisms = {{ mechanisms | safe }};  // From Flask, an array of available mechanisms
        

        function toggleSelection(type, number) {
            const container = document.getElementById(type + '_container_' + number);
            const toggle = document.getElementById(type + '_toggle_' + number).checked;
            
            if (toggle) {
                container.style.display = 'flex';  // Show the dropdown
                randomizeSelection(type, number)
            } else {
                container.style.display = 'none';  // Hide the dropdown
                document.getElementById(type + '_dropdown_' + number).value = '';  // Clear the selection
            }
            updateMechanismCount();
            updateThemeCount();
        }

        function randomizeSelection(type, number) {
            const select = document.getElementById(type + '_dropdown_' + number);
            const options = type === 'theme' ? allThemes : allMechanisms;
            const randomOption = options[Math.floor(Math.random() * options.length)];
            select.value = randomOption;
        }

        function updateMechanismCount() {
            let mechanismCount = 1;  // Mechanism 1 is always selected
            if (document.getElementById('mechanism_toggle_2').checked) mechanismCount++;
            if (document.getElementById('mechanism_toggle_3').checked) mechanismCount++;
            document.getElementById('mechanism_num_input').value = mechanismCount;
        }

        function updateThemeCount() {
            let themeCount = 1;  // Theme 1 is always selected
            if (document.getElementById('theme_toggle_2').checked) themeCount++;
            if (document.getElementById('theme_toggle_3').checked) themeCount++;
            document.getElementById('theme_num_input').value = themeCount;
        }

        function checkMaxPlayer(){
            if (document.getElementById('player_count_max').value < document.getElementById('player_count_min').value ){
                document.getElementById('player_count_max').value = document.getElementById('player_count_min').value
            }
        }

        function checkMinPlayer(){
            if (document.getElementById('player_count_max').value < document.getElementById('player_count_min').value ){
                document.getElementById('player_count_min').value = document.getElementById('player_count_max').value
            }
        }

        function enforceReload() {
            randomizeSelection('mechanism', 1)
            randomizeSelection('theme', 1)
            enforceClick('mechanism', 2)
            enforceClick('theme', 2)
            enforceClick('mechanism', 3)
            enforceClick('theme', 3)
        }
        function enforceClick(type, number){
            document.getElementById(type + '_toggle_' + number).click();
            if (document.getElementById(type + '_toggle_' + number).checked){
                document.getElementById(type + '_toggle_' + number).click();
            }
        }
        function submitForm(event) {
            event.preventDefault();

            const formData = new FormData(document.getElementById('gameForm'));

            // Only include selected themes and mechanisms based on toggles
            const selectedThemes = [];
            const selectedMechanisms = [];

            // Add the selected themes if their toggle is on
            selectedThemes.push(formData.get('themes[0]'));
            if ((document.getElementById('theme_toggle_2').checked) && (formData.get('themes[1]')!='')) {
                selectedThemes.push(formData.get('themes[1]'));
            }
            if ((document.getElementById('theme_toggle_3').checked) && (formData.get('themes[2]')!='')){
                selectedThemes.push(formData.get('themes[2]'));
            }

            // Add the selected mechanisms if their toggle is on
            selectedMechanisms.push(formData.get('mechanisms[0]'));
            if ((document.getElementById('mechanism_toggle_2').checked) && (formData.get('mechanisms[1]')!='')){
                selectedMechanisms.push(formData.get('mechanisms[1]'));
            }
            if ((document.getElementById('mechanism_toggle_3').checked) && (formData.get('mechanisms[1]')!='')){
                selectedMechanisms.push(formData.get('mechanisms[2]'));
            }

            
            const formObj = {
                theme_num: parseInt(formData.get('theme_num'), 10) || 0,
                mechanism_num: parseInt(formData.get('mechanism_num'), 10) || 0,
                player_count_min: formData.get('player_count_min'),
                player_count_max: formData.get('player_count_max'),
                game_length: formData.get('game_length'),
                game_type: formData.get('game_type'),
                themes: selectedThemes,
                mechanisms: selectedMechanisms
            };

            // Send the form data to the server using fetch
            fetch('/generate_idea', {
                method: 'POST',
                body: JSON.stringify(formObj), // Send as JSON
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json(); // Parse the response as JSON
            })
            .then(data => {
                if (data.board_game_idea) {
                    // Convert the board game idea Markdown to HTML
                    const formattedIdea = marked.parse(data.board_game_idea);

                    // Display the formatted HTML in the response container
                    document.getElementById('response_container').innerHTML = `
                        <h2>Generated Board Game Idea</h2>
                        <div class="idea-box">${formattedIdea}</div>
                    `;
                } else {
                    document.getElementById('response_container').innerHTML = `
                        <p style="color:red;">Error: Board game idea not found in the response.</p>
                    `;
                }
            })
        }
    </script>
</head>
<body onload="enforceReload()">

<div class="container">
    <h1>Board Game Idea Generator</h1>

    <form id="gameForm" onsubmit="submitForm(event)">
        <!-- Other inputs for player count, game length, etc. -->
        <div class="row_box">
            <label>Game Type</label>
            <div class="input_options_box">
                <select id="game_type" name="game_type">
                    <option value="competitive" selected="selected">Competitive</option>
                    <option value="cooperative">Cooperative</option>
                    <option value="team">Team</option>
                </select>
            </div>
        </div>
        <div class="row_box">
            <label>Min Players</label>
            <div class="input_options_box">
                <input type="number" id="player_count_min" name="player_count_min" min="1" max="10" value="2" onchange="checkMaxPlayer()">
            </div>
        </div>
        <div class="row_box">
            <label>Max Players</label>
            <div class="input_options_box">
                <input type="number" id="player_count_max" name="player_count_max" min="1" max="10" value="4" onchange="checkMinPlayer()">
            </div>
        </div>
        <div class="row_box">
            <label>Game Length</label>
            <div class="input_options_box">
                <select id="game_length" name="game_length">
                    <option value="30 mins" selected="selected">30 mins</option>
                    <option value="45 mins">45 mins</option>
                    <option value="1 hour">1 hour</option>
                    <option value="1.5 hours">1.5 hours</option>
                    <option value="2 hours">2 hours</option>
                    <option value="3 hours">3 hours</option>
                </select>
            </div>
        </div>

        <!-- Mechanism 1 (dummpy toggle)-->
        <div class="row_box">
            <label for="mechanism_toggle_1">Mechanism 1 </label>
            <label class="switch">
                <input type="checkbox" id="mechanism_toggle_1" name="mechanism_toggle_1" onclick="return false" checked>
                <span class="slider round"></span>
            </label>
            <div id="mechanism_container_1" class="input_options_toggle">
                <select id="mechanism_dropdown_1" name="mechanisms[0]">
                    {% for mechanism in mechanisms %}
                    <option value="{{ mechanism }}">{{ mechanism }}</option>
                    {% endfor %}
                </select>
                <button type="button" class="random-button" onclick="randomizeSelection('mechanism', 1)">Random</button>
            </div>
        </div>
        

        <!-- Mechanism 2 (toggle) -->
        <div class="row_box">
            <label for="mechanism_toggle_2">Mechanism 2 </label>
            <label class="switch">
                <input type="checkbox" id="mechanism_toggle_2" name="mechanism_toggle_2" onchange="toggleSelection('mechanism', 2)">
                <span class="slider round"></span>
            </label>
            <div class="input_options_box">
                <div id="mechanism_container_2" class="input_options_toggle">
                    <select id="mechanism_dropdown_2" name="mechanisms[1]">
                        {% for mechanism in mechanisms %}
                        <option value="{{ mechanism }}">{{ mechanism }}</option>
                        {% endfor %}
                    </select>
                    <button type="button" class="random-button" onclick="randomizeSelection('mechanism', 2)">Random</button>
                </div>
            </div>
        </div>
        

        <!-- Mechanism 3 (toggle) -->
        <div class="row_box">
            <label for="mechanism_toggle_3">Mechanism 3 </label>
            <label class="switch">
                <input type="checkbox" id="mechanism_toggle_3" name="mechanism_toggle_3" onchange="toggleSelection('mechanism', 3)">
                <span class="slider round"></span>
            </label>
            <div class="input_options_box">
                <div id="mechanism_container_3" class="input_options_toggle">
                    <select id="mechanism_dropdown_3" name="mechanisms[2]">
                        {% for mechanism in mechanisms %}
                        <option value="{{ mechanism }}">{{ mechanism }}</option>
                        {% endfor %}
                    </select>
                    <button type="button" class="random-button" onclick="randomizeSelection('mechanism', 3)">Random</button>
                </div>
            </div>
        </div>
        

        <!-- Theme 1 (dummpy toggle) -->
        <div class="row_box">
            <label for="mechanism_toggle_1">Theme 1 </label>
            <label class="switch">
                <input type="checkbox" id="theme_toggle_1" name="theme_toggle_1" onclick="return false" checked>
                <span class="slider round"></span>
            </label>
            <div id="theme_container_1" class="input_options_toggle">
                <select id="theme_dropdown_1" name="themes[0]">
                    {% for theme in themes %}
                    <option value="{{ theme }}">{{ theme }}</option>
                    {% endfor %}
                </select>
                <button type="button" class="random-button" onclick="randomizeSelection('theme', 1)">Random</button>
            </div>
        </div>
        

        <!-- Theme 2 (toggle) -->
        <div class="row_box">
            <label for="theme_toggle_2">Theme 2 </label>
            <label class="switch">
                <input type="checkbox" id="theme_toggle_2" name="theme_toggle_2" onchange="toggleSelection('theme', 2)">
                <span class="slider round"></span>
            </label>
            <div class="input_options_box">
                <div id="theme_container_2" class="input_options_toggle">
                    <select id="theme_dropdown_2" name="themes[1]">
                        {% for theme in themes %}
                        <option value="{{ theme }}">{{ theme }}</option>
                        {% endfor %}
                    </select>
                    <button type="button" class="random-button" onclick="randomizeSelection('theme', 2)">Random</button>
                </div>
            </div>
        </div>
        

        <!-- Theme 3 (toggle) -->
        <div class="row_box">
            <label for="theme_toggle_3">Theme 3 </label>
            <label class="switch">
                <input type="checkbox" id="theme_toggle_3" name="theme_toggle_3" onchange="toggleSelection('theme', 3)">
                <span class="slider round"></span>
            </label>
            <div class="input_options_box">
                <div id="theme_container_3" class="input_options_toggle">
                    <select id="theme_dropdown_3" name="themes[2]">
                        {% for theme in themes %}
                        <option value="{{ theme }}">{{ theme }}</option>
                        {% endfor %}
                    </select>
                    <button type="button" class="random-button" onclick="randomizeSelection('theme', 3)">Random</button>
                </div>
            </div>
        </div>
                
        <input type="hidden" id="theme_num_input" name="theme_num" value="1">
        <input type="hidden" id="mechanism_num_input" name="mechanism_num" value="1">
        <div class="row_box2">
            <button type="submit">Generate Idea</button>
        </div>
    </form>

    <div id="response_container" style="margin-top: 20px;">
        <!-- Display the generated board game idea here -->
    </div>
</div>

</body>
</html>
